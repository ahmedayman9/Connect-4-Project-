
// ******* Required Hardware I/O connections*******************
// Slide pot pin 1 connected to ground
// Slide pot pin 2 connected to PE2/AIN1
// Slide pot pin 3 connected to +3.3V
// fire button connected to PE0
// special weapon fire button connected to PE1
// 8*R resistor DAC bit 0 on PB0 (least significant bit)
// 4*R resistor DAC bit 1 on PB1
// 2*R resistor DAC bit 2 on PB2
// 1*R resistor DAC bit 3 on PB3 (most significant bit)
// LED on PB4
// LED on PB5

// Blue Nokia 5110
// ---------------
// Signal        (Nokia 5110) LaunchPad pin
// Reset         (RST, pin 1) connected to PA7
// SSI0Fss       (CE,  pin 2) connected to PA3
// Data/Command  (DC,  pin 3) connected to PA6
// SSI0Tx        (Din, pin 4) connected to PA5
// SSI0Clk       (Clk, pin 5) connected to PA2
// 3.3V          (Vcc, pin 6) power
// back light    (BL,  pin 7) not connected, consists of 4 white LEDs which draw ~80mA total
// Ground        (Gnd, pin 8) ground

#include "tm4c123gh6pm.h"
#include "Nokia5110.h"
#include "Random.h"
#include "TExaS.h"
#include <string.h>
#include <stdlib.h>
#include <math.h>
#include "PortF.h"
#include "uart.h"


// *************************** Images ***************************
// width=16 x height=10

#define BOARD_ROWS 6
#define BOARD_COLS 7


const unsigned char logo1[] ={
 0x42, 0x4D, 0x4A, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x76, 0x00, 0x00, 0x00, 0x28, 0x00, 0x00, 0x00, 0x38, 0x00, 0x00, 0x00, 0x23, 0x00, 0x00, 0x00, 0x01, 0x00, 0x04, 0x00, 0x00, 0x00,
 0x00, 0x00, 0xD4, 0x03, 0x00, 0x00, 0xC4, 0x0E, 0x00, 0x00, 0xC4, 0x0E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x80,
 0x00, 0x00, 0x00, 0x80, 0x80, 0x00, 0x80, 0x00, 0x00, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x80, 0x00, 0x00, 0x80, 0x80, 0x80, 0x00, 0xC0, 0xC0, 0xC0, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0xFF,
 0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0xFF, 0x00, 0x00, 0x00, 0xFF, 0x00, 0xFF, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x88, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x88, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x88, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x88, 0x80, 0x00, 0x00, 0x07, 0x77, 0x70, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x88, 0x80, 0x00, 0x00, 0x08, 0xF8, 0xF7, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
 0x00, 0x08, 0x88, 0x80, 0x00, 0x00, 0x88, 0x88, 0x88, 0x00, 0x03, 0x00, 0x00, 0x08, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x88, 0x88,
 0x88, 0x00, 0x88, 0x88, 0x8F, 0x00, 0x8F, 0xF7, 0x00, 0x0F, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x88, 0x88, 0x88, 0x80, 0x78, 0x88,
 0xFF, 0x07, 0xFF, 0xFF, 0x00, 0x08, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x88, 0x88, 0x88, 0x80, 0x07, 0x8F, 0xF0, 0x07, 0xF8, 0x7F,
 0x00, 0x88, 0x80, 0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x88, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0xF7, 0x0F, 0x00, 0x88, 0x30, 0x88,
 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x88, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0xF7, 0x08, 0x00, 0x88, 0x88, 0x8F, 0x70, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x88, 0x88, 0x00, 0x00, 0x00, 0x07, 0x88, 0x70, 0x0F, 0xF0, 0x08, 0x08, 0x80, 0x0F, 0x87, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x00, 0x00, 0x00, 0x88, 0x88, 0x80, 0x00, 0x00, 0x78, 0x88, 0x88, 0x0F, 0xF0, 0x0F, 0x08, 0x80, 0x07, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
 0x00, 0x88, 0x88, 0x88, 0x88, 0x00, 0xFF, 0x88, 0x8F, 0x00, 0x00, 0x08, 0x08, 0x80, 0x07, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x88, 0x88,
 0x88, 0x00, 0x88, 0x88, 0xF8, 0x00, 0x00, 0x00, 0x08, 0x88, 0x7F, 0x70, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x88,
 0xF7, 0x00, 0x00, 0x00, 0x00, 0x88, 0x88, 0x70, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x77, 0x70, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x28, 0x87, 0x70, 0x00, 0x00, 0x00, 0x00, 0x08, 0x80, 0x07, 0x07, 0x70, 0x08, 0x70,
 0x7F, 0x8F, 0x70, 0x07, 0x78, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x78, 0x88, 0x88, 0xF8, 0x70, 0x00, 0x00, 0x00, 0x08, 0x80, 0x08, 0x07, 0x80, 0x88, 0x70, 0x7F, 0x87, 0x70, 0x88,
 0x88, 0x80, 0x00, 0xF7, 0x00, 0x00, 0x00, 0x00, 0x07, 0xFF, 0xFF, 0x77, 0x78, 0x70, 0x00, 0x88, 0x73, 0x0F, 0x80, 0x88, 0x07, 0x70, 0x88, 0x70, 0x78, 0x00, 0x08, 0xF8, 0x77, 0x80, 0x00, 0xF7,
 0x00, 0x00, 0x00, 0x00, 0x07, 0xF8, 0x87, 0x00, 0x07, 0x70, 0x08, 0x88, 0x88, 0x08, 0x88, 0x88, 0x07, 0x78, 0x88, 0x70, 0x7F, 0x88, 0x08, 0xF7, 0x00, 0x00, 0x00, 0xF7, 0x00, 0x00, 0x00, 0x00,
 0x77, 0x88, 0x87, 0x00, 0x00, 0x70, 0x88, 0x88, 0x88, 0x08, 0x88, 0x88, 0x07, 0x88, 0x87, 0x70, 0x7F, 0xF8, 0x08, 0xF7, 0x00, 0x00, 0x00, 0xF7, 0x00, 0x00, 0x00, 0x00, 0x68, 0x88, 0x70, 0x00,
 0x00, 0x00, 0x88, 0x88, 0x88, 0x08, 0x88, 0x88, 0x07, 0x88, 0x00, 0x70, 0x88, 0x70, 0x08, 0xF7, 0x00, 0x20, 0x00, 0xF7, 0x00, 0x00, 0x00, 0x00, 0x68, 0x88, 0x70, 0x00, 0x00, 0x00, 0x08, 0x88,
 0x87, 0x08, 0x88, 0x08, 0x08, 0x87, 0x00, 0x80, 0xF8, 0x77, 0x08, 0xF7, 0x33, 0x00, 0x08, 0xF8, 0x70, 0x00, 0x00, 0x00, 0x68, 0x88, 0x70, 0x00, 0x00, 0x00, 0x00, 0xF8, 0x00, 0x08, 0x80, 0x08,
 0x07, 0xF7, 0x03, 0x80, 0x7F, 0x88, 0x00, 0xFF, 0x78, 0x00, 0x8F, 0xFF, 0xF8, 0x00, 0x00, 0x00, 0x78, 0x88, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x00, 0x08, 0x00, 0x80, 0x00, 0x00,
 0x8F, 0xFF, 0x70, 0x8F, 0xFF, 0x00, 0xFF, 0x88, 0xF7, 0x00, 0x00, 0x00, 0x08, 0x8F, 0xF7, 0x00, 0x06, 0x70, 0x00, 0x08, 0x70, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x77, 0x00, 0x00,
 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xFF, 0xF7, 0x00, 0x07, 0x70, 0x78, 0x8F, 0x87, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x00, 0x00, 0x07, 0xFF, 0x8E, 0x70, 0x68, 0x00, 0x78, 0x88, 0x88, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
 0x00, 0x0F, 0x8E, 0x88, 0xF8, 0x00, 0x78, 0x88, 0x88, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x78, 0x87,
 0x70, 0x00, 0x7F, 0x88, 0x8F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0xFF,
 0x84, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF,

};

void printBoard(char *board);
int takeTurn(char *board, int player, const char *);
int takeTurnRemote(char *board, int player, const char *);
int takeTurnAI(char *board, int player, const char *);
int hasEmptyCol(char *board, int col);
int changeBoard(char *board, int player, const char *PIECES, int col);
int checkWin(char *board);
int checkFour(char *board, int, int, int, int);
int horizontalCheck(char *board);
int verticalCheck(char *board);
int diagonalCheck(char *board);
void Delay100ms(unsigned long count); // time delay in 0.1 seconds

int horiCheck(char *board);
int vertiCheck(char *board);
int fourth(char *board);
int checkThree(char *board, int a, int b, int c, int d);

void DisableInterrupts(void); // Disable interrupts
void EnableInterrupts(void);  // Enable interrupts
long StartCritical (void);    // previous I bit, disable interrupts
void EndCritical(long sr);    // restore I bit to previous value
void WaitForInterrupt(void);  // low power mode

int flag;
int k=0;
int flag2=0;
int cols;
int avoid;

int count;


unsigned long SW1, SW2; // input from PF4,PF0
int selectMode(void);
void startingScreen(void);


int i = 0; 
int turn = 0, done = 0;
const char *PIECES = "xo";                  //array 2 values PIECES[0] = X, PIECES[1] = O
char board1[(BOARD_ROWS * BOARD_COLS) + 1]; // board1[6x7 + 1] = [43] .. leh msh 42??? 8aleban board[42] = '/0' bma eno array of char

int main(void)
{
    //TExaS_Init(SSI0_Real_Nokia5110_Scope);  // set system clock to 80 MHz
    // initialization goes here
    int mode,w;

    PortF_Init(); // Call initialization of port PF4, PF3, PF2, PF1, PF0
		EdgeCounter_Init();
    for (i = 0; i < BOARD_COLS * BOARD_ROWS + 1; i++)  // ngrb nshel el +1
    {
        board1[i] = ' ';
        //input[i]=' ';
    }
    //  kol elli gwa array el board space "fady"
    //   0  1  2  3  4  5  6
    //                          0
    //                          1
    //                          2
    //                          3
    //                          4
    //                          5

    Nokia5110_Init();
    UARTB_init();
    Nokia5110_Clear();
    startingScreen();
    mode = selectMode(); // mode 0 or 2
    Nokia5110_Clear();
    if (mode) // if mode = 1 .. p1 vs p2 .. UART
    { 

        printBoard(board1);
        for (turn = 0; turn < (BOARD_ROWS * BOARD_COLS) && !done; turn++)  
        { // from 0 to 42 and the game is not done yet (no winner)

		do
		{
		    printBoard(board1);
		} while (!takeTurn(board1, (turn) % 2, PIECES));
		done = checkWin(board1);
		turn++;
		if (done)
		    break;
		do
		{
		    printBoard(board1);
		} while (!takeTurnRemote(board1, (turn) % 2, PIECES));
		done = checkWin(board1);
            
        }
        printBoard(board1);
        if (turn == BOARD_ROWS * BOARD_COLS && !done)
        { // grid is full but there's no winner
            Nokia5110_OutString("It's a tie!");
        }
        else
        { // done = 1, there's a winner
            turn--;                 // bsbb enna zawdna el turn abl el check of winner (done)
            Nokia5110_Clear();
            Nokia5110_SetCursor(1, 1);
            Nokia5110_OutString("Player");
            Nokia5110_SetCursor(8, 1);
            Nokia5110_OutString(turn % 2 == 0 ? "X" : "O");
            Nokia5110_SetCursor(3, 2);
            Nokia5110_OutString("wins!");
            Nokia5110_SetCursor(1, 4);
            Nokia5110_OutString("GAME OVER");
					
		for (w = 0; w < 7; w++)
		{
			GPIO_PORTF_DATA_R |= (1<<1)| (1<<3);
			Delay100ms(5);
			GPIO_PORTF_DATA_R &= ~((1<<1)| (1<<3));

			GPIO_PORTF_DATA_R |= (1<<2);
			Delay100ms(5);

			GPIO_PORTF_DATA_R &= ~(1<<2);
			Delay100ms(5);
		}
        }
    }
    else
    {
        // playes vs ai
        printBoard(board1);
        for (turn = 0; turn < (BOARD_ROWS * BOARD_COLS) && !done; turn++)
        { // 42
           
	do
            {
                printBoard(board1);
            } while (!takeTurn(board1, (turn) % 2, PIECES));
            done = checkWin(board1);
            turn++;
            if (done)
                break;
	 do
            {
                printBoard(board1);
            } while (!takeTurnAI(board1, (turn) % 2, PIECES));
            
            done = checkWin(board1);
        }
        printBoard(board1);
        if (turn == BOARD_ROWS * BOARD_COLS && !done)
        {
            Nokia5110_OutString("It's a tie!");
        }
        else
        {
            turn--;
            Nokia5110_Clear();
            Nokia5110_SetCursor(1, 1);
            Nokia5110_OutString("Player");
            Nokia5110_SetCursor(8, 1);
            Nokia5110_OutString(turn % 2 == 0 ? "X" : "O");
            Nokia5110_SetCursor(3, 2);
            Nokia5110_OutString("wins!");
            Nokia5110_SetCursor(1, 4);
            Nokia5110_OutString("GAME OVER");
					
	for (w = 0; w < 7; w++)
	{
		GPIO_PORTF_DATA_R |= (1<<1)| (1<<3);
		Delay100ms(5);
		GPIO_PORTF_DATA_R &= ~((1<<1)| (1<<3));

		GPIO_PORTF_DATA_R |= (1<<2);
		Delay100ms(5);

		GPIO_PORTF_DATA_R &= ~(1<<2);
		Delay100ms(5);
	}
        }
    }
	while(1){
		WaitForInterrupt();
	}
		
}


void startingScreen()
{
    int w;
    Nokia5110_SetCursor(0, 0);
    Nokia5110_ClearBuffer();
    Nokia5110_PrintBMP(10, 35, logo1, 0)
    Nokia5110_DisplayBuffer();
    Nokia5110_SetCursor(0, 5);
    Nokia5110_OutString("Welcome :D!");
    Delay100ms(40);
    for (w = 0; w < 7; w++)
    {
        Nokia5110_SetCursor(0, w);
        Nokia5110_OutString("           ");
	GPIO_PORTF_DATA_R |= (1<<1)| (1<<3);
	Delay100ms(5);
	GPIO_PORTF_DATA_R &= ~((1<<1)| (1<<3));

	GPIO_PORTF_DATA_R |= (1<<2);
	Delay100ms(5);

	GPIO_PORTF_DATA_R &= ~(1<<2);
        Delay100ms(5);
    }
}

// take turn for the Kit player and PIECES can be X or O
int takeTurn(char *board, int player, const char *PIECES)
{
		int g;
    cols = 0;
	
    while (1)
    {

			SW1 = GPIO_PORTF_DATA_R & 0x10; // read PF4 into SW1
			SW2 = GPIO_PORTF_DATA_R & 0x01; // read PF4 into SW2

			Nokia5110_SetCursorChar(cols, 0, PIECES[player]);
			g = cols == 0 ? 6 : cols - 1;
			Nokia5110_SetCursorChar(g, 0, board[g]);            // momken nst5dm setcursor b3dha out char


			if (flag)
			{
				
				UARTB_OutChar(cols + 1 + '0');			//momken ashelha
				flag=0;
				return changeBoard(board, player, PIECES, cols);
			}
						
    }
   
}

int takeTurnAI(char *board, int player, const char *PIECES)
{
	int col ; 
	int v=0;

	for(i=0;i<BOARD_COLS;i++)
	{
		if(hasEmptyCol(board,i))
		{
			v+=1;
		}
	}
	
	while(v>0){

		if(fourth(board))
		{
			return changeBoard(board , player , PIECES , avoid );
		}
		else{
			col=rand()%BOARD_COLS; //func el random
			if(hasEmptyCol(board,col))
			{
				return changeBoard(board, player, PIECES, col); 
			}
  	}
	}
return 0;	
}

int takeTurnRemote(char *board, int player, const char *PIECES) //x o
{

    int col = 0;
    col = UARTB_InChar(); // bkhod el data elli f reg el data fl uart .. arkam in asscci
    col = col - 1 - '0';  // col -1 3shan ana array mn 0 .... -'0' 3shan a7wl mn char to intg
		col = col%7;
	
int hasEmptyCol(char *board, int col)       // bymshi mn ta7t l fo2 fi nfs el col y-check 3la 7eta fadya
{
    int row;
    for (row = BOARD_ROWS - 1; row >= 0; row--)
    {
        if (board[BOARD_COLS * row + col] == ' ')
        {
            return 1;
        }
    }
    return 0;
}
